<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Mynet Yerel | İstanbul Haber Portalı</title>
    <link
      rel="icon"
      href="https://upload.wikimedia.org/wikipedia/tr/3/38/Mynet.svg"
      type="image/png"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --mynet-blue: #002d72;
        --mynet-red: #e30613;
      }
      body {
        background-color: #f3f4f6;
        font-family: "Segoe UI", sans-serif;
      }

      .nav-btn {
        white-space: nowrap;
        font-weight: 800;
        font-size: 11px;
        color: white;
        padding: 16px 14px;
        transition: 0.2s;
        border-right: 1px solid rgba(255, 255, 255, 0.12);
      }
      .nav-active {
        background: var(--mynet-red) !important;
      }

      .ad-box {
        background: #e5e7eb;
        border: 1px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- ÜST REKLAM -->
    <div class="w-full flex justify-center bg-gray-50 py-4 border-b">
      <div class="ad-box w-[970px] h-[90px]">TEPE REKLAM - 970x90</div>
    </div>

    <nav
      class="bg-[#002d72] sticky top-0 z-50 border-b-4 border-red-600 shadow-xl"
    >
      <div class="container mx-auto flex items-center">
        <div class="bg-white px-5 py-2 mr-2 flex-shrink-0">
          <img
            src="https://upload.wikimedia.org/wikipedia/tr/3/38/Mynet.svg"
            class="h-10 cursor-pointer"
            onclick="location.href = '/'"
          />
        </div>
        <div id="nav" class="flex overflow-x-auto no-scrollbar"></div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8 flex gap-6">
      <!-- SOL REKLAM -->
      <aside class="w-[160px] hidden lg:block">
        <div class="ad-box w-[160px] h-[600px] sticky top-28 text-center px-2">
          SOL REKLAM - 160x600
        </div>
      </aside>

      <main class="flex-grow">
        <h2
          id="stitle"
          class="text-3xl font-black text-blue-900 border-l-8 border-red-600 pl-4 mb-8 uppercase italic tracking-tighter"
        >
          İstanbul Son Dakika
        </h2>

        <div
          id="grid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"
        ></div>
      </main>

      <!-- SAĞ REKLAM -->
      <aside class="w-[160px] hidden xl:block">
        <div class="ad-box w-[160px] h-[600px] sticky top-28 text-center px-2">
          SAĞ REKLAM - 160x600
        </div>
      </aside>
    </div>

    <script>
      const districts = [
        "Adalar",
        "Arnavutköy",
        "Ataşehir",
        "Avcılar",
        "Bağcılar",
        "Bahçelievler",
        "Bakırköy",
        "Başakşehir",
        "Bayrampaşa",
        "Beşiktaş",
        "Beykoz",
        "Beylikdüzü",
        "Beyoğlu",
        "Büyükçekmece",
        "Çatalca",
        "Çekmeköy",
        "Esenler",
        "Esenyurt",
        "Eyüpsultan",
        "Fatih",
        "Gaziosmanpaşa",
        "Güngören",
        "Kadıköy",
        "Kağıthane",
        "Kartal",
        "Küçükçekmece",
        "Maltepe",
        "Pendik",
        "Sancaktepe",
        "Sarıyer",
        "Silivri",
        "Sultanbeyli",
        "Sultangazi",
        "Şile",
        "Şişli",
        "Tuzla",
        "Ümraniye",
        "Üsküdar",
        "Zeytinburnu",
      ].sort();

      const nav = document.getElementById("nav");
      const titleEl = document.getElementById("stitle");

      // NAV
      nav.innerHTML = `
      <button onclick="loadNews('get-breaking', this, 'İstanbul Son Dakika')" class="nav-btn nav-active">SON DAKİKA</button>
    `;
      districts.forEach((d) => {
        nav.innerHTML += `<button onclick="loadNews('get-news/${d}', this, '${d}')" class="nav-btn uppercase">${d}</button>`;
      });

      // Başlığa göre alakalı stok görsel üret
      function smartStockImg(title = "") {
        const t = title.toLowerCase();

        const rules = [
          {
            k: [
              "kaza",
              "çarp",
              "zincirleme",
              "tem",
              "e-5",
              "otoyol",
              "trafik",
              "gişe",
            ],
            q: "traffic,accident,road",
          },
          {
            k: ["yangın", "itfaiye", "alev", "duman"],
            q: "fire,firefighters,emergency",
          },
          {
            k: ["polis", "operasyon", "gözaltı", "asayiş", "soruşturma"],
            q: "police,security,city",
          },
          {
            k: ["belediye", "başkan", "meclis", "ihale", "valilik"],
            q: "cityhall,municipality,government",
          },
          {
            k: ["metro", "metrobüs", "otobüs", "tramvay", "vapuru", "iskele"],
            q: "public-transport,istanbul",
          },
          { k: ["fırtına", "yağmur", "kar", "sel"], q: "storm,rain,city" },
          {
            k: [
              "boğaz",
              "sahil",
              "deniz",
              "kadıköy",
              "beşiktaş",
              "üsküdar",
              "beyoğlu",
            ],
            q: "bosporus,istanbul,street",
          },
        ];

        let q = "istanbul,city";
        for (const r of rules) {
          if (r.k.some((w) => t.includes(w))) {
            q = r.q;
            break;
          }
        }

        const sig = Math.floor(Math.random() * 999999);
        return `https://source.unsplash.com/800x500/?${encodeURIComponent(q)}&sig=${sig}`;
      }

      // Backend image proxy
      function proxied(imgUrl) {
        return `/img?u=${encodeURIComponent(imgUrl)}`;
      }

      async function loadNews(path, btn, pageTitle) {
        // İlçe tıklayınca başlık değişsin
        titleEl.textContent = pageTitle || "İstanbul";

        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("nav-active"));
        btn.classList.add("nav-active");

        const grid = document.getElementById("grid");
        grid.innerHTML = `
        <div class="col-span-full text-center py-20 font-bold text-gray-400 animate-pulse italic uppercase tracking-widest">
          Haberler yükleniyor...
        </div>
      `;

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 12000);

        try {
          const res = await fetch(`/${path}`, {
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          clearTimeout(timer);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          grid.innerHTML = "";

          (data || []).forEach((item, i) => {
            // Grid içi sponsor: 2. slot + sonra her 6 haberde bir
            if (i === 1 || (i > 1 && (i - 1) % 6 === 0)) {
              grid.innerHTML += `<div class="ad-box h-64 rounded bg-gray-200 italic shadow-inner">SPONSORLU İÇERİK</div>`;
            }

            const fallback = smartStockImg(item?.title || "");
            const imgSrc = item?.image ? proxied(item.image) : fallback;

            grid.innerHTML += `
            <a href="${item?.link || "#"}" target="_blank"
               class="bg-white shadow hover:shadow-2xl transition rounded overflow-hidden flex flex-col group border-b-4 border-transparent hover:border-red-600">
              <div class="h-44 overflow-hidden relative">
                <img
                  src="${imgSrc}"
                  onerror="this.onerror=null; this.src='${fallback}'"
                  referrerpolicy="no-referrer"
                  class="w-full h-full object-cover group-hover:scale-110 transition duration-500"
                  loading="lazy"
                  decoding="async"
                >
                <span class="absolute top-2 left-2 bg-red-600 text-white text-[9px] px-2 py-1 font-bold rounded uppercase tracking-tighter">
                  ${item?.source || "Haber"}
                </span>
              </div>
              <div class="p-4 flex-grow">
                <h3 class="font-bold text-[13px] text-blue-900 leading-tight line-clamp-3 group-hover:text-red-600">
                  ${item?.title || ""}
                </h3>
                <div class="mt-4 flex justify-between items-center text-[10px] text-gray-400 font-bold border-t pt-2 uppercase">
                  <span>${item?.date || "--:--"}</span>
                  <span class="text-blue-900 font-black italic">OKU ></span>
                </div>
              </div>
            </a>
          `;
          });

          if (!data || data.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-16 font-bold text-gray-400">Bu sayfada haber bulunamadı.</div>`;
          }
        } catch (e) {
          clearTimeout(timer);
          grid.innerHTML = `<div class="col-span-full text-center py-16 font-bold text-red-600">
          Sunucu/Feed hatası: ${e?.message || e}
        </div>`;
        }
      }

      window.onload = () => document.querySelector(".nav-btn").click();
    </script>
  </body>
</html>
